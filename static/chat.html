<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gana Insurance â€” Claim Chat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: #16213e;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #0f3460;
        }
        .header h1 { font-size: 1.25rem; font-weight: 600; }
        .header p { font-size: 0.875rem; color: #94a3b8; margin-top: 0.25rem; }
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .msg { max-width: 85%; width: fit-content; padding: 0.75rem 1rem; border-radius: 1rem; line-height: 1.4; }
        .msg.user { align-self: flex-end; background: #0f3460; color: #e2e8f0; }
        .msg.assistant { align-self: flex-start; background: #0f3460; border: 1px solid #1e3a5f; }
        .msg .meta { font-size: 0.7rem; color: #94a3b8; margin-bottom: 0.25rem; }
        .claim-box {
            margin-top: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: rgba(34, 197, 94, 0.15);
            border-radius: 0.5rem;
            font-size: 0.8rem;
            border-left: 3px solid #22c55e;
        }
        .claim-box strong { display: block; margin-bottom: 0.25rem; }
        .input-area {
            padding: 1rem 1.5rem;
            background: #16213e;
            border-top: 1px solid #0f3460;
        }
        .preview { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem; }
        .preview img { width: 60px; height: 60px; object-fit: cover; border-radius: 0.5rem; border: 1px solid #0f3460; }
        .preview .remove { position: absolute; top: 2px; right: 2px; background: #dc2626; color: #fff; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; cursor: pointer; }
        .preview .thumb { position: relative; }
        .row { display: flex; gap: 0.5rem; align-items: center; }
        .row input[type="text"] {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #0f3460;
            border-radius: 0.5rem;
            background: #1a1a2e;
            color: #e2e8f0;
            font-size: 1rem;
        }
        .row input[type="text"]:focus { outline: none; border-color: #3b82f6; }
        .row input[type="file"] { display: none; }
        .row label.btn {
            padding: 0.75rem 1rem;
            background: #0f3460;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1.1rem;
        }
        .row label.btn:hover { background: #1e3a5f; }
        .row button[type="button"] {
            padding: 0.75rem 1.25rem;
            background: #3b82f6;
            color: #fff;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
        }
        .row button[type="button"]:hover { background: #2563eb; }
        .row button[type="button"]:disabled { opacity: 0.6; cursor: not-allowed; }
        .submit-btn { background: #22c55e; color: #fff; padding: 0.75rem 1.25rem; border: none; border-radius: 0.5rem; font-weight: 500; cursor: pointer; }
        .submit-btn:hover { background: #16a34a; }
        .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .loading { display: inline-block; width: 18px; height: 18px; border: 2px solid rgba(59,130,246,0.3); border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error { background: rgba(220,38,38,0.2); border-left-color: #dc2626; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Gana Insurance</h1>
        <p>Chat with Sarah â€” file an operational liability claim</p>
    </div>
    <div class="messages" id="messages">
        <div class="msg assistant">
            <div class="meta">Sarah</div>
            Hi! I'm Sarah. I'm here to help you file a claim. Can I start with your company name and policy number?
        </div>
    </div>
    <div class="input-area">
        <div class="preview" id="preview"></div>
        <div class="row" id="submitRow" style="display: none;">
            <button type="button" id="submitClaim" class="btn submit-btn">Submit claim</button>
        </div>
        <div class="row">
            <input type="file" id="file" accept="image/*" multiple>
            <label for="file" class="btn">ðŸ“·</label>
            <input type="text" id="input" placeholder="Type your message..." autocomplete="off">
            <button type="button" id="send">Send</button>
        </div>
    </div>

    <script>
        (function () {
            var API = window.location.origin;
            var sessionId = null;
            var selectedFiles = [];

            function addMsg(role, text, isError) {
                var wrap = document.getElementById('messages');
                var div = document.createElement('div');
                div.className = 'msg ' + role;
                var meta = role === 'user' ? 'You' : 'Sarah';
                div.innerHTML = '<div class="meta">' + meta + '</div>' + (isError ? '<span class="error">' + text + '</span>' : text);
                wrap.appendChild(div);
                wrap.scrollTop = wrap.scrollHeight;
            }

            function addClaimBox(data) {
                if (!data || !data.claimant) return;
                var wrap = document.getElementById('messages');
                var parts = [];
                if (data.claimant.name) parts.push('Name: ' + data.claimant.name);
                if (data.claimant.policy_number) parts.push('Policy: ' + data.claimant.policy_number);
                if (data.incident && data.incident.incident_type && data.incident.incident_type !== 'unknown') parts.push('Type: ' + data.incident.incident_type);
                if (data.operational_impact && data.operational_impact.estimated_liability_cost != null) parts.push('Cost: $' + data.operational_impact.estimated_liability_cost);
                if (data.is_complete) parts.push('âœ“ Complete');
                var existing = wrap.querySelector('.claim-box');
                if (existing) {
                    existing.innerHTML = '<strong>Claim info</strong>' + parts.join(' Â· ');
                } else {
                    var box = document.createElement('div');
                    box.className = 'claim-box';
                    box.innerHTML = '<strong>Claim info</strong>' + parts.join(' Â· ');
                    wrap.appendChild(box);
                }
                wrap.scrollTop = wrap.scrollHeight;
            }

            function showPreview() {
                var container = document.getElementById('preview');
                container.innerHTML = '';
                selectedFiles.forEach(function (f, i) {
                    var url = URL.createObjectURL(f);
                    var thumb = document.createElement('div');
                    thumb.className = 'thumb';
                    thumb.innerHTML = '<img src="' + url + '" alt=""><button class="remove" type="button">Ã—</button>';
                    thumb.querySelector('.remove').onclick = function () {
                        selectedFiles.splice(i, 1);
                        showPreview();
                    };
                    container.appendChild(thumb);
                });
            }

            document.getElementById('file').onchange = function () {
                var files = this.files;
                for (var i = 0; i < files.length; i++) selectedFiles.push(files[i]);
                showPreview();
                this.value = '';
            };

            document.getElementById('send').onclick = send;
            document.getElementById('input').onkeydown = function (e) {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
            };

            document.getElementById('submitClaim').onclick = function () {
                if (!sessionId) return;
                var btn = this;
                btn.disabled = true;
                btn.textContent = 'Submittingâ€¦';
                var form = new FormData();
                form.append('session_id', sessionId);
                fetch(API + '/api/chat/submit', { method: 'POST', body: form })
                    .then(function (r) { return r.ok ? r.json() : r.text().then(function (t) { throw new Error(t || r.status); }); })
                    .then(function (data) {
                        if (data.message) addMsg('assistant', data.message);
                        var submitRow = document.getElementById('submitRow');
                        if (submitRow) submitRow.style.display = 'none';
                    })
                    .catch(function (err) {
                        addMsg('assistant', 'Sorry, submission failed: ' + (err.message || err), true);
                        btn.disabled = false;
                        btn.textContent = 'Submit claim';
                    })
                    .finally(function () {
                        if (btn.disabled && btn.textContent === 'Submittingâ€¦') btn.textContent = 'Submitted';
                    });
            };

            function send() {
                var input = document.getElementById('input');
                var btn = document.getElementById('send');
                var text = (input.value || '').trim();
                if (!text && selectedFiles.length === 0) return;

                input.value = '';
                addMsg('user', text || 'ðŸ“· [Sent photo(s)]');
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span>';

                var form = new FormData();
                form.append('message', text || 'I attached some photos.');
                if (sessionId) form.append('session_id', sessionId);
                selectedFiles.forEach(function (f) { form.append('images', f); });
                selectedFiles = [];
                showPreview();

                fetch(API + '/api/chat', { method: 'POST', body: form })
                    .then(function (r) { return r.ok ? r.json() : r.text().then(function (t) { throw new Error(t || r.status); }); })
                    .then(function (data) {
                        if (data.session_id) sessionId = data.session_id;
                        addMsg('assistant', data.assistant_message || '');
                        if (data.claim_data && (data.claim_data.claimant || data.claim_data.incident)) addClaimBox(data.claim_data);
                        var submitRow = document.getElementById('submitRow');
                        if (submitRow) submitRow.style.display = data.is_complete ? 'flex' : 'none';
                    })
                    .catch(function (err) {
                        addMsg('assistant', 'Sorry, something went wrong: ' + (err.message || err), true);
                    })
                    .finally(function () {
                        btn.disabled = false;
                        btn.textContent = 'Send';
                        input.focus();
                    });
            }
        })();
    </script>
</body>
</html>
